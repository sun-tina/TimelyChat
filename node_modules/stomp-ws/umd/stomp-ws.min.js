!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).StompWs=t()}(this,(function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class t extends Error{constructor(e){super(e),Object.setPrototypeOf(this,t.prototype)}}const n=new TextDecoder,o=new TextEncoder;function s(e){return e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/:/g,"\\c")}function r(e){return e.replace(/\\\\/g,"\\").replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\c/g,":")}function i(e){const{command:t,headers:n,body:r}=e;let i=t+"\n";if(n)for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&(i+=s(e)+":"+s(n[e])+"\n");if(r){const e=r.length,t=o.encode(i+"content-length:"+e+"\n\n"),n=new Uint8Array(t.length+e+1);return n.set(t),n.set(r,t.length),n[t.length+e]=0,n}return o.encode(i+"\n\0")}function a(e,n,o){const s={...e.headers};for(const e of n){if(void 0===s[e])throw new t("Did not contain "+e+" header.");delete s[e]}if(!0===o)return;if(o)for(const e of o)void 0!==s[e]&&delete s[e];const r=Object.keys(s);if(r.length>0)throw new t("Contain extra header: "+r.join(", ")+".")}function c(e){if(e.body)throw new t("Contain body in "+e.command+".")}function d(e){const s=e.data;if((s.length||s.byteLength)>1){const e=function(e){const s="string"==typeof e?o.encode(e):new Uint8Array(e);if(0!==s[s.length-1])throw new t("Frame is not terminated with a NULL character.");let i=0;function a(){let e=i;for(;e<s.length&&10!==s[e];)e+=1;if(e>=s.length)return n.decode(s.slice(i));const t=n.decode(s.slice(i,e));return i=e+1,t}const c=a();let d=a();const h={command:c};for(;d;){const e=d.split(":");if(2!==e.length)throw new t("Contain an invalid header.");const n=r(e[0]);if(h.headers||(h.headers={}),!h.headers[n]){const t=r(e[1]);h.headers[n]=t}d=a()}const l=s.slice(i,-1);return l.length&&(h.body=l),h}(s);if(!function(e){const{command:n}=e;if("CONNECTED"===n){c(e),a(e,["version"],["session","server","heart-beat"]);const n=e.headers&&e.headers["heart-beat"];if(n&&!/^\d+,\d+$/.test(n))throw new t("Malformed heart-beat option.")}else if("MESSAGE"===n)a(e,["destination"],!0);else if("RECEIPT"===n)c(e),a(e,["receipt-id"]);else{if("ERROR"!==n)return!1;a(e,[],!0)}return!0}(e))throw new t("Unknown command: "+e.command);return e}if("\n"!==s[0]&&10!==s[0])throw new Error("Unknown message: "+s);return null}return class{constructor(t,n){e(this,"url",void 0),e(this,"options",void 0),e(this,"ws",void 0),e(this,"_connected",!1),e(this,"_lastSend",0),e(this,"_lastRecv",0),this.url=t,this.options=n}send(e){const t=this.ws;t&&(this._lastSend=Date.now(),t.send(i(e)))}async listen(e){const t=this.ws;if(t)return new Promise(((n,o)=>{const s=()=>{o(new Error("Socket closed."))},r=t=>{try{const s=d(t.data);if(!s)return;Promise.resolve(e(s)).then((e=>{e&&(i(),n(s))})).catch((e=>{i(),o(e)}))}catch(e){i(),o(e)}},i=()=>{t.removeEventListener("close",s),t.removeEventListener("message",r)};t.addEventListener("close",s),t.addEventListener("message",r)}))}close(){const e=this.ws;e&&e.close()}get connected(){return this._connected}get host(){var e;if(null!==(e=this.options)&&void 0!==e&&e.host)return this.options.host;return new URL(this.url).host}handleError(e){var t;if("ERROR"===(null==e?void 0:e.command))throw null===(t=this.ws)||void 0===t||t.close(),new Error(e.headers.message)}heartBeat(e,t){var n,o;const s=t.split(","),r=parseInt(s[0],10),i=parseInt(s[1],10),a=(null===(n=this.options)||void 0===n?void 0:n.clientHeartBeat)||0,c=(null===(o=this.options)||void 0===o?void 0:o.serverHeartBeat)||0,d=a&&i?Math.max(a,i):0,h=r&&c?Math.max(r,c):0;if(d){const t=setInterval((()=>{Date.now()-this._lastSend>d/2&&(this._lastSend=Date.now(),e.send("\n"))}),d/2);e.addEventListener("close",(()=>{clearInterval(t)}))}if(h){const t=setInterval((()=>{Date.now()-this._lastRecv>1.5*h&&e.close()}),h);e.addEventListener("message",(()=>{this._lastRecv=Date.now()})),e.addEventListener("close",(()=>{clearInterval(t)}))}}async connect(){if(!this.ws||this.ws.readyState===WebSocket.CLOSING||this.ws.readyState===WebSocket.CLOSED){const e=new WebSocket(this.url);this.ws=e,e.binaryType="arraybuffer",await new Promise(((t,n)=>{const o=s=>{try{const n=d(s);if(!n)return;if(e.removeEventListener("message",o),this.handleError(n),"CONNECTED"!==n.command)throw new Error("Expect CONNECTED frame. Got "+n.command);this._connected=!0,this._lastRecv=Date.now(),this.heartBeat(e,n.headers["heart-beat"]||"0,0"),t()}catch(t){console.error(t),e.close(),n(t)}};e.addEventListener("message",o);const s=()=>{var t,n;this._lastSend=Date.now();const o=(null===(t=this.options)||void 0===t?void 0:t.clientHeartBeat)||0,s=(null===(n=this.options)||void 0===n?void 0:n.serverHeartBeat)||0;e.send(i({command:"CONNECT",headers:{"accept-version":"1.2",host:this.host,"heart-beat":`${o},${s}`}}))};e.readyState===WebSocket.OPEN?s():e.onopen=s,e.addEventListener("close",(()=>{this.ws=void 0,this._connected=!1,setTimeout((()=>{this.connect()}),500)}))}))}}}}));
//# sourceMappingURL=stomp-ws.min.js.map
